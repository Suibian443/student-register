<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Results - Student Register</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#9b59b6">

    <style>
        /* Base Styles */
        body { padding-bottom: 70px !important; }
        .controls-row { display: flex; gap: 10px; margin-bottom: 10px; }
        
        select { 
            flex: 1; padding: 12px; border-radius: 8px; 
            border: 1px solid var(--border); background: var(--card); 
            color: var(--text); width: 100%; font-size: 14px;
        }

        /* Action Buttons */
        .btn-mini {
            padding: 0 15px; font-size: 18px; background: var(--card);
            border: 1px solid var(--border); border-radius: 8px; cursor: pointer; color: var(--text);
            display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .btn-mini:active { transform: scale(0.95); }

        /* Result Card */
        .result-card {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--card); padding: 15px; margin-bottom: 10px;
            border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
        }
        .student-info h4 { margin: 0; font-size: 16px; color: var(--text); }
        .student-info p { margin: 5px 0 0; font-size: 13px; color: var(--placeholder); }
        .card-actions { display: flex; align-items: center; gap: 10px; }
        
        .score-input {
            width: 60px; padding: 10px; font-size: 18px; font-weight: bold;
            text-align: center; border: 2px solid var(--border); border-radius: 8px;
            background: var(--bg); color: var(--text); transition: 0.2s;
        }
        .score-input:focus { border-color: var(--primary); background: var(--card); outline: none; }
        .progress-btn {
            background: transparent; border: 1px solid var(--border); 
            border-radius: 8px; cursor: pointer; padding: 8px; font-size: 16px;
        }

        /* Status Colors */
        .passing { border-color: #27ae60 !important; color: #27ae60; background: #ecfdf5; }
        .failing { border-color: #e74c3c !important; color: #e74c3c; background: #fef2f2; }
        [data-theme="dark"] .passing { background: #064e3b; color: #6ee7b7; }
        [data-theme="dark"] .failing { background: #7f1d1d; color: #fca5a5; }

        .theme-toggle {
            background: var(--card); border: 1px solid var(--border); color: var(--text);
            padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 16px;
        }

        /* MODALS */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 1000;
            backdrop-filter: blur(3px);
        }
        .modal-content {
            background: var(--card); padding: 25px; border-radius: 20px; width: 85%; max-width: 350px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: left; animation: popUp 0.3s ease;
            max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;
        }
        @keyframes popUp { from {transform: scale(0.8); opacity:0;} to {transform: scale(1); opacity:1;} }

        /* üèÜ LEADERBOARD STYLES */
        .rank-item { 
            display: flex; justify-content: space-between; padding: 12px; 
            border-bottom: 1px solid var(--border); align-items: center; 
        }
        
        .rank-badge { 
            width: 35px; height: 35px; border-radius: 50%; 
            background: var(--bg); color: var(--text); 
            display: flex; align-items: center; justify-content: center; 
            font-size: 18px; margin-right: 12px;
            border: 1px solid var(--border);
        }

        /* Specific styles for the top 5 just to make the emoji pop a bit more */
        .rank-1 .rank-badge, .rank-2 .rank-badge, 
        .rank-3 .rank-badge, .rank-4 .rank-badge, 
        .rank-5 .rank-badge {
            background: transparent; 
            border: none;
            font-size: 24px; /* Bigger Emojis */
            box-shadow: none;
        }
        
        .prog-row { margin-bottom: 10px; }
        .prog-label { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 3px; color: var(--text); }
        .prog-bar-bg { width: 100%; height: 8px; background: var(--bg); border-radius: 4px; overflow: hidden; }
        .prog-bar-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.5s ease; }
        .btn-close { width:100%; padding:12px; background:var(--bg); border:1px solid var(--border); border-radius:8px; color:var(--text); font-weight:bold; margin-top:15px; }
    
        /* Floating Bar Styles */
        body { padding-bottom: 70px !important; }
        .bottom-nav {
            position: fixed !important; bottom: 15px !important; left: 50% !important;
            transform: translateX(-50%) !important; width: 75% !important;
            max-width: 350px !important; height: 48px !important;
            background-color: #ffffff !important; display: none !important;
            justify-content: space-evenly !important; align-items: center !important;
            border-radius: 30px !important; border: 1px solid #c0c0c0 !important;
            box-shadow: 0 12px 35px rgba(0,0,0,0.25) !important; z-index: 9999 !important;
        }
        [data-theme="dark"] .bottom-nav {
            background-color: #2c2c2c !important; border: 1px solid #444 !important;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8) !important;
        }
        .nav-item {
            background: transparent !important; border: none !important;
            color: #999 !important; display: flex !important; flex-direction: column !important;
            align-items: center !important; justify-content: center !important;
            font-size: 9px !important; width: auto !important; height: 100% !important;
            padding: 0 5px !important; margin: 0 !important; cursor: pointer !important;
            position: relative !important;
        }
        .nav-icon {
            font-size: 20px !important; margin-bottom: 2px !important;
            display: block !important; transition: transform 0.2s !important;
        }
        .nav-item.active { color: #9b59b6 !important; font-weight: bold !important; }
        .nav-item.active::after {
            content: '' !important; position: absolute !important; bottom: 5px !important;
            width: 36px !important; height: 3px !important; background-color: #9b59b6 !important;
            border-radius: 10px !important;
        }
        [data-theme="dark"] .nav-item.active { color: #e0b0ff !important; }
        [data-theme="dark"] .nav-item.active::after { background-color: #e0b0ff !important; box-shadow: 0 0 6px rgba(224, 176, 255, 0.6) !important; }
        .nav-item.active .nav-icon { transform: translateY(-2px) !important; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <div style="display:flex; align-items:center; gap:10px;">
                <div style="line-height:1.2;">
                    <h3 style="margin:0; color:var(--text);">Results</h3>
                </div>
            </div>
            <button class="theme-toggle" id="themeBtn" onclick="toggleLocalTheme()">üåô</button>
        </div>

        <div class="controls-row">
            <select id="resClass" onchange="handleContextChange()">
                <option value="6">Class 6</option>
                <option value="7">Class 7</option>
                <option value="8">Class 8</option>
                <option value="9">Class 9</option>
                <option value="10">Class 10</option>
            </select>
            <select id="subject" onchange="handleContextChange()">
                <option value="Math">Math</option>
                <option value="English">English</option>
                <option value="Science">Science</option>
            </select>
        </div>

        <div class="controls-row">
            <select id="examType" onchange="loadResults()" style="flex:2;">
                </select>
            <button class="btn-mini" onclick="openTestModal()">‚ûï</button>
            <button class="btn-mini" onclick="openLeaderboard()" style="color:#f1c40f;">üèÜ</button>
        </div>

        <hr style="border:0; border-top:1px solid var(--border); margin:20px 0;">

        <div id="resultsList"></div>
    </div>

    <div id="testModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-top:0; color:var(--text);">Manage Tests</h3>
            <p style="font-size:12px; color:var(--placeholder); margin-bottom:15px;">For <span id="modalSubjectName"></span></p>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input type="text" id="newTestName" placeholder="Ex: Trigonometry" style="padding:10px; border-radius:8px; border:1px solid var(--border); width:100%;">
                <button onclick="addNewTest()" style="background:var(--primary); color:white; border:none; padding:0 15px; border-radius:8px; font-weight:bold;">+</button>
            </div>
            <div id="testList" style="max-height:200px; overflow-y:auto; margin-bottom:15px; border:1px solid var(--border); border-radius:8px;"></div>
            <button class="btn-close" onclick="closeModals()">Close</button>
        </div>
    </div>

    <div id="leaderboardModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-top:0; color:var(--text); text-align:center;">Leaderboard</h3>
            <p id="lbSubtitle" style="text-align:center; color:var(--placeholder); font-size:12px; margin-bottom:15px;"></p>
            <div id="leaderboardList" style="overflow-y:auto; flex:1;"></div>
            <button class="btn-close" onclick="closeModals()">Close</button>
        </div>
    </div>

    <div id="progressModal" class="modal">
        <div class="modal-content">
            <h3 id="progTitle" style="margin-top:0; color:var(--text);">Student Progress</h3>
            <p style="color:var(--placeholder); font-size:12px; margin-bottom:15px;">Performance in <span id="progSubject"></span></p>
            <div id="progressList" style="max-height:300px; overflow-y:auto;"></div>
            <button class="btn-close" onclick="closeModals()">Close</button>
        </div>
    </div>

    <div class="bottom-nav">
        <button onclick="window.location.href='index.html'" class="nav-item">
            <span class="nav-icon">üë®‚Äçüéì</span>
        </button>
        <button onclick="window.location.href='attendance.html'" class="nav-item">
            <span class="nav-icon">üìÖ</span>
        </button>
        <button onclick="window.location.href='results.html'" class="nav-item active">
            <span class="nav-icon">üìä</span>
        </button>
    </div>

    <script>
        // 1. Initialize
        window.onload = function() {
            const savedTheme = localStorage.getItem("theme") || "light";
            document.body.setAttribute("data-theme", savedTheme);
            document.getElementById("themeBtn").innerText = savedTheme === "dark" ? "‚òÄÔ∏è" : "üåô";
            
            loadExamTypes(); 
            loadResults();
        };

        function toggleLocalTheme() {
            const current = document.body.getAttribute("data-theme");
            const newTheme = current === "dark" ? "light" : "dark";
            document.body.setAttribute("data-theme", newTheme);
            localStorage.setItem("theme", newTheme);
            document.getElementById("themeBtn").innerText = newTheme === "dark" ? "‚òÄÔ∏è" : "üåô";
        }

        function getStorageKey() {
            const cls = document.getElementById("resClass").value;
            const sub = document.getElementById("subject").value;
            return `exams_${cls}_${sub}`;
        }

        function handleContextChange() {
            loadExamTypes();
            loadResults();
        }

        // 2. Exam Management
        function loadExamTypes() {
            const dropdown = document.getElementById("examType");
            const key = getStorageKey();
            let tests = JSON.parse(localStorage.getItem(key));
            if (!tests || tests.length === 0) tests = ["Mid-Term", "Final Exam"];

            dropdown.innerHTML = "";
            tests.forEach(t => dropdown.innerHTML += `<option value="${t}">${t}</option>`);
            dropdown.selectedIndex = 0;
        }

        function openTestModal() {
            document.getElementById("testModal").style.display = "flex";
            document.getElementById("modalSubjectName").innerText = 
                `${document.getElementById("resClass").value} - ${document.getElementById("subject").value}`;
            renderTestList();
        }

        function renderTestList() {
            const list = document.getElementById("testList");
            const key = getStorageKey();
            let tests = JSON.parse(localStorage.getItem(key)) || ["Mid-Term", "Final Exam"];
            
            list.innerHTML = "";
            tests.forEach((t, index) => {
                list.innerHTML += `
                <div class="test-item">
                    <span>${t}</span>
                    <button class="btn-del" onclick="deleteTest(${index})">‚úï</button>
                </div>`;
            });
        }

        function addNewTest() {
            const input = document.getElementById("newTestName");
            const name = input.value.trim();
            if(!name) return;
            const key = getStorageKey();
            let tests = JSON.parse(localStorage.getItem(key)) || ["Mid-Term", "Final Exam"];
            tests.push(name);
            localStorage.setItem(key, JSON.stringify(tests));
            input.value = "";
            renderTestList();
            loadExamTypes(); 
        }

        function deleteTest(index) {
            if(!confirm("Delete this test?")) return;
            const key = getStorageKey();
            let tests = JSON.parse(localStorage.getItem(key));
            tests.splice(index, 1);
            localStorage.setItem(key, JSON.stringify(tests));
            renderTestList();
            loadExamTypes();
        }

        function closeModals() {
            document.querySelectorAll(".modal").forEach(m => m.style.display = "none");
        }

        // 3. Main Result Logic
        function loadResults() {
            const listContainer = document.getElementById("resultsList");
            const selectedClass = document.getElementById("resClass").value;
            const exam = document.getElementById("examType").value;
            const subject = document.getElementById("subject").value;
            
            const students = JSON.parse(localStorage.getItem("students")) || [];
            const allResults = JSON.parse(localStorage.getItem("results_data")) || {};

            const classStudents = students.filter(s => s.studentClass === selectedClass);
            classStudents.sort((a, b) => parseInt(a.roll) - parseInt(b.roll));

            if (classStudents.length === 0) {
                listContainer.innerHTML = `<div style="text-align:center; padding:30px; color:var(--placeholder);">No students in Class ${selectedClass}.</div>`;
                return;
            }

            let html = "";
            classStudents.forEach(s => {
                const key = `${exam}_${subject}_${s.studentClass}_${s.roll}`;
                const savedScore = allResults[key] || ""; 
                let colorClass = "";
                if(savedScore !== "") colorClass = parseInt(savedScore) >= 33 ? "passing" : "failing";

                html += `
                <div class="result-card">
                    <div class="student-info">
                        <h4>${s.name}</h4>
                        <p>Roll: ${s.roll}</p>
                    </div>
                    <div class="card-actions">
                        <button class="progress-btn" onclick="openStudentProgress('${s.roll}', '${s.name}')">üìà</button>
                        <input type="tel" class="score-input ${colorClass}" 
                            id="input_${key}" value="${savedScore}" 
                            placeholder="--" maxlength="3"
                            oninput="saveResult('${key}', this)">
                    </div>
                </div>`;
            });
            listContainer.innerHTML = html;
        }

        function saveResult(key, inputElement) {
            let allResults = JSON.parse(localStorage.getItem("results_data")) || {};
            const val = inputElement.value;
            if(isNaN(val)) return;

            allResults[key] = val;
            localStorage.setItem("results_data", JSON.stringify(allResults));

            if (val !== "") {
                if (parseInt(val) >= 33) {
                    inputElement.classList.add("passing"); inputElement.classList.remove("failing");
                } else {
                    inputElement.classList.add("failing"); inputElement.classList.remove("passing");
                }
            } else {
                inputElement.classList.remove("passing", "failing");
            }
        }

         // 4. üèÜ LEADERBOARD LOGIC (Updated with Emojis)
        function openLeaderboard() {
            const selectedClass = document.getElementById("resClass").value;
            const exam = document.getElementById("examType").value;
            const subject = document.getElementById("subject").value;
            const students = JSON.parse(localStorage.getItem("students")) || [];
            const allResults = JSON.parse(localStorage.getItem("results_data")) || {};

            const classStudents = students.filter(s => s.studentClass === selectedClass);
            
            let scoredStudents = classStudents.map(s => {
                const key = `${exam}_${subject}_${s.studentClass}_${s.roll}`;
                const score = parseInt(allResults[key]) || 0;
                return { name: s.name, score: score, roll: s.roll };
            });

            scoredStudents = scoredStudents.filter(s => s.score > 0);
            scoredStudents.sort((a, b) => b.score - a.score);

            const lbList = document.getElementById("leaderboardList");
            document.getElementById("lbSubtitle").innerText = `${exam} - ${subject} (Class ${selectedClass})`;
            
            if (scoredStudents.length === 0) {
                lbList.innerHTML = "<p style='text-align:center'>No marks entered yet.</p>";
            } else {
                let html = "";
                scoredStudents.forEach((s, index) => {
                    // üõë EMOJI LOGIC HERE
                    let rankDisplay = index + 1;
                    if(index === 0) rankDisplay = "üëë";
                    else if(index === 1) rankDisplay = "üíé";
                    else if(index === 2) rankDisplay = "üéñÔ∏è";
                    else if(index === 3) rankDisplay = "üèÖ";
                    else if(index === 4) rankDisplay = "‚≠ê";

                    html += `
                    <div class="rank-item rank-${index+1}">
                        <div style="display:flex; align-items:center;">
                            <div class="rank-badge">${rankDisplay}</div> 
                            <div>
                                <strong style="display:block;">${s.name}</strong>
                                <small style="color:var(--placeholder)">Roll: ${s.roll}</small>
                            </div>
                        </div>
                        <span style="font-weight:bold; font-size:16px;">${s.score}</span>
                    </div>`;
                });
                lbList.innerHTML = html;
            }
            document.getElementById("leaderboardModal").style.display = "flex";
        }

        // 5. PROGRESS LOGIC
        function openStudentProgress(roll, name) {
            document.getElementById("progTitle").innerText = name;
            const subject = document.getElementById("subject").value;
            document.getElementById("progSubject").innerText = subject;

            const selectedClass = document.getElementById("resClass").value;
            const keyPrefix = getStorageKey(); 
            let tests = JSON.parse(localStorage.getItem(keyPrefix)) || ["Mid-Term", "Final Exam"];
            
            const allResults = JSON.parse(localStorage.getItem("results_data")) || {};
            const progList = document.getElementById("progressList");

            let html = "";
            let hasData = false;

            tests.forEach(test => {
                const key = `${test}_${subject}_${selectedClass}_${roll}`;
                const score = parseInt(allResults[key]);
                
                if(!isNaN(score)) {
                    hasData = true;
                    let color = "#e74c3c"; 
                    if(score >= 80) color = "#27ae60"; 
                    else if(score >= 33) color = "#f1c40f"; 
                    
                    html += `
                    <div class="prog-row">
                        <div class="prog-label">
                            <span>${test}</span>
                            <span>${score}%</span>
                        </div>
                        <div class="prog-bar-bg">
                            <div class="prog-bar-fill" style="width:${score}%; background:${color};"></div>
                        </div>
                    </div>`;
                }
            });

            if(!hasData) html = "<p style='text-align:center; color:var(--placeholder)'>No exams taken yet.</p>";
            progList.innerHTML = html;

            document.getElementById("progressModal").style.display = "flex";
        }
    </script>
    
    <script src="script.js?v=30005"></script>

</body>
</html>