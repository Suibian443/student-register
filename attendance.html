<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Attendance - Student Register</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#9b59b6">

    <style>
        /* Base Styles */
        body { padding-bottom: 70px !important; }
        .controls-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        
        select, input[type="date"] { 
            flex: 1; padding: 12px; border-radius: 8px; 
            border: 1px solid var(--border); background: var(--card); 
            color: var(--text); font-size: 14px;
        }

        /* üìä DAILY SUMMARY CARDS */
        .daily-summary {
            display: flex; gap: 10px; margin-bottom: 20px;
        }
        .d-card {
            flex: 1; padding: 15px; border-radius: 12px;
            color: white; text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; justify-content: center;
        }
        .d-card h4 { margin: 0; font-size: 12px; opacity: 0.9; text-transform: uppercase; }
        .d-card span { font-size: 28px; font-weight: 800; line-height: 1.2; }
        
        .bg-present { background-color: #27ae60; }
        .bg-absent { background-color: #c0392b; }

        /* üìã STUDENT LIST ITEM (Row) */
        .student-row {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--card); padding: 12px 15px; margin-bottom: 10px;
            border-radius: 12px; border: 1px solid var(--border);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .stu-info { flex: 1; cursor: pointer; } /* Clicking name opens history */
        .stu-info h4 { margin: 0; color: var(--text); font-size: 15px; }
        .stu-info p { margin: 2px 0 0; color: var(--placeholder); font-size: 12px; }

        /* üîò ATTENDANCE TOGGLE BUTTON */
        .att-btn {
            width: 100px; padding: 10px 0; border-radius: 8px;
            font-weight: bold; font-size: 13px; text-transform: uppercase;
            border: none; cursor: pointer; transition: 0.2s;
            text-align: center;
        }
        .btn-p { background: #e8f8f5; color: #27ae60; border: 1px solid #27ae60; }
        .btn-a { background: #fdedec; color: #c0392b; border: 1px solid #c0392b; }
        .btn-u { background: var(--bg); color: var(--placeholder); border: 1px solid var(--border); }
        .btn-h { background: #fef5e7; color: #f39c12; border: 1px solid #f39c12; pointer-events: none; } /* Holiday */

        /* Dark Mode Adjustments */
        [data-theme="dark"] .btn-p { background: #0e6655; color: white; border: none; }
        [data-theme="dark"] .btn-a { background: #78281f; color: white; border: none; }
        [data-theme="dark"] .btn-u { background: #333; color: #aaa; }


 /* üíæ SAVE BAR (Fixed Bottom) */
        #saveBar {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(100px);
            width: 90%; max-width: 400px;
            background: #2c3e50; padding: 10px 20px; border-radius: 50px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4); z-index: 2000;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #saveBar.show { transform: translateX(-50%) translateY(0); }
        #saveBar span { color: white; font-weight: bold; font-size: 14px; }
        .btn-save-confirm {
            background: #27ae60; color: white; border: none; 
            padding: 8px 20px; border-radius: 20px; font-weight: bold; cursor: pointer;
        }



        /* MODAL & CALENDAR STYLES (For History) */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 1000;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background: var(--card); padding: 20px; border-radius: 20px; 
            width: 90%; max-width: 400px; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            max-height: 90vh; overflow-y: auto;
        }

        .calendar-grid {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 20px; margin-top: 15px;
        }
        .cal-day {
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
            background: var(--bg); border-radius: 8px; border: 1px solid var(--border);
            font-weight: bold; font-size: 14px; color: var(--text);
        }
        .is-present { background-color: #27ae60 !important; color: white !important; border:none; }
        .is-absent  { background-color: #c0392b !important; color: white !important; border:none; }
        .is-holiday { background-color: #f39c12 !important; color: white !important; border:none; }

        .btn-close { width: 100%; padding: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-weight: bold; }

        /* Theme Toggle */
        .theme-toggle {
            background: var(--card); border: 1px solid var(--border); color: var(--text);
            padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 16px;
        }
        
        /* Floating Bar Styles */
        body { padding-bottom: 70px !important; }
        .bottom-nav {
            position: fixed !important; bottom: 15px !important; left: 50% !important;
            transform: translateX(-50%) !important; width: 75% !important;
            max-width: 350px !important; height: 48px !important;
            background-color: #ffffff !important; display: none !important;
            justify-content: space-evenly !important; align-items: center !important;
            border-radius: 30px !important; border: 1px solid #c0c0c0 !important;
            box-shadow: 0 12px 35px rgba(0,0,0,0.25) !important; z-index: 9999 !important;
        }
        [data-theme="dark"] .bottom-nav {
            background-color: #2c2c2c !important; border: 1px solid #444 !important;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8) !important;
        }
        .nav-item {
            background: transparent !important; border: none !important;
            color: #999 !important; display: flex !important; flex-direction: column !important;
            align-items: center !important; justify-content: center !important;
            font-size: 9px !important; width: auto !important; height: 100% !important;
            padding: 0 5px !important; margin: 0 !important; cursor: pointer !important;
            position: relative !important;
        }
        .nav-icon {
            font-size: 20px !important; margin-bottom: 2px !important;
            display: block !important; transition: transform 0.2s !important;
        }
        .nav-item.active { color: #9b59b6 !important; font-weight: bold !important; }
        .nav-item.active::after {
            content: '' !important; position: absolute !important; bottom: 5px !important;
            width: 36px !important; height: 3px !important; background-color: #9b59b6 !important;
            border-radius: 10px !important;
        }
        [data-theme="dark"] .nav-item.active { color: #e0b0ff !important; }
        [data-theme="dark"] .nav-item.active::after { background-color: #e0b0ff !important; box-shadow: 0 0 6px rgba(224, 176, 255, 0.6) !important; }
        .nav-item.active .nav-icon { transform: translateY(-2px) !important; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0; color:var(--text);">Attendance</h3>
            <button class="theme-toggle" id="themeBtn" onclick="toggleLocalTheme()">üåô</button>
        </div>

        <div class="controls-row">
            <input type="date" id="attDate" onchange="loadDailyView()" style="flex:2;">
            <button onclick="openGlobalHolidayModal()" style="flex:1; padding:12px; background:var(--card); border:1px solid var(--border); border-radius:8px; cursor:pointer; color:var(--text); font-weight:bold;">üèñÔ∏è Holidays</button>
        </div>
        
        <div class="controls-row">
             <select id="attClass" onchange="loadDailyView()">
                <option value="6">Class 6</option>
                <option value="7">Class 7</option>
                <option value="8">Class 8</option>
                <option value="9">Class 9</option>
                <option value="10">Class 10</option>
            </select>
        </div>

        <div class="daily-summary">
            <div class="d-card bg-present">
                <h4>Present</h4>
                <span id="sumP">0</span>
            </div>
            <div class="d-card bg-absent">
                <h4>Absent</h4>
                <span id="sumA">0</span>
            </div>
        </div>

        <hr style="border:0; border-top:1px solid var(--border); margin:15px 0;">

        <div id="attList"></div>
        <div style="height: 60px;"></div>
    </div>


    <div id="saveBar">
        <span>‚ö†Ô∏è Unsaved Changes</span>
        <button class="btn-save-confirm" onclick="saveAttendance()">Save Now</button>
    </div>

    <div id="historyModal" class="modal">
        <div class="modal-content">
            <h3 id="histName" style="margin:0; color:var(--text);">Student Name</h3>
            <p style="font-size:12px; color:var(--placeholder); margin-bottom:10px;">Full Month View</p>
            <div class="calendar-grid" id="histGrid"></div>
            <button class="btn-close" onclick="document.getElementById('historyModal').style.display='none'">Close</button>
        </div>
    </div>

    <div id="holidayModal" class="modal">
        <div class="modal-content">
            <h3 style="margin:0 0 5px 0; color:var(--text);">Manage Holidays</h3>
            <p style="font-size:12px; color:var(--placeholder); margin-bottom:20px;">Tap days to mark as School Holiday</p>
            <div class="calendar-grid" id="holidayGrid"></div>
            <button class="btn-close" onclick="document.getElementById('holidayModal').style.display='none'; loadDailyView();">Done</button>
        </div>
    </div>

    <div class="bottom-nav">
        <button onclick="window.location.href='index.html'" class="nav-item">
            <span class="nav-icon">üë®‚Äçüéì</span>
        </button>
        <button onclick="window.location.href='attendance.html'" class="nav-item active">
            <span class="nav-icon">üìÖ</span>
        </button>
        <button onclick="window.location.href='results.html'" class="nav-item">
            <span class="nav-icon">üìä</span>
        </button>
    </div>

    <script>
        window.onload = function() {
            const savedTheme = localStorage.getItem("theme") || "light";
            document.body.setAttribute("data-theme", savedTheme);
            document.getElementById("themeBtn").innerText = savedTheme === "dark" ? "‚òÄÔ∏è" : "üåô";

            // Set default date to TODAY
            document.getElementById("attDate").valueAsDate = new Date();
            loadDailyView();
        };

        function toggleLocalTheme() {
            const current = document.body.getAttribute("data-theme");
            const newTheme = current === "dark" ? "light" : "dark";
            document.body.setAttribute("data-theme", newTheme);
            localStorage.setItem("theme", newTheme);
            document.getElementById("themeBtn").innerText = newTheme === "dark" ? "‚òÄÔ∏è" : "üåô";
        }

        // 1. LOAD DAILY LIST & BUTTONS
        function loadDailyView() {
            const cls = document.getElementById("attClass").value;
            const fullDate = document.getElementById("attDate").value; // "YYYY-MM-DD"
            
            if(!fullDate) return;

            const [year, month, day] = fullDate.split('-');
            const monthStr = `${year}-${month}`; // Key for storage: YYYY-MM
            const dayNum = parseInt(day);

            // Get Data
            const students = JSON.parse(localStorage.getItem("students")) || [];
            const attData = JSON.parse(localStorage.getItem(`att_${cls}_${monthStr}`)) || {};
            const holidays = JSON.parse(localStorage.getItem(`holidays_${monthStr}`)) || [];

            const isHoliday = holidays.includes(dayNum);

            // Filter Class
            const filtered = students.filter(s => s.studentClass === cls);
            filtered.sort((a, b) => parseInt(a.roll) - parseInt(b.roll));

            const list = document.getElementById("attList");
            list.innerHTML = "";

            let countP = 0;
            let countA = 0;

            if(filtered.length === 0) {
                list.innerHTML = "<div style='text-align:center; padding:20px; color:var(--placeholder)'>No students found.</div>";
                return;
            }

            filtered.forEach(s => {
                // Get Status for this specific day
                const studentRecord = attData[s.roll] || {};
                const status = studentRecord[dayNum]; // 'P', 'A', or undefined

                // Calculate Totals
                if(!isHoliday) {
                    if(status === 'P') countP++;
                    if(status === 'A') countA++;
                }

                // Determine Button Appearance
                let btnClass = "btn-u";
                let btnText = "Mark";
                
                if (isHoliday) {
                    btnClass = "btn-h";
                    btnText = "Holiday";
                } else if (status === 'P') {
                    btnClass = "btn-p";
                    btnText = "Present";
                } else if (status === 'A') {
                    btnClass = "btn-a";
                    btnText = "Absent";
                }

                list.innerHTML += `
                <div class="student-row">
                    <div class="stu-info" onclick="openHistoryModal('${s.roll}', '${s.name}')">
                        <h4>${s.name}</h4>
                        <p>Roll: ${s.roll}</p>
                    </div>
                    <button class="att-btn ${btnClass}" onclick="toggleAttendance('${s.roll}', ${isHoliday})">
                        ${btnText}
                    </button>
                </div>`;
            });

            // Update Header Counts
            document.getElementById("sumP").innerText = countP;
            document.getElementById("sumA").innerText = countA;
        }

        // 2. TOGGLE ATTENDANCE LOGIC
        function toggleAttendance(roll, isHoliday) {
            if(isHoliday) {
                alert("Cannot mark attendance on a Holiday! Unmark the holiday first.");
                return;
            }

            const cls = document.getElementById("attClass").value;
            const fullDate = document.getElementById("attDate").value; 
            const [year, month, day] = fullDate.split('-');
            const monthStr = `${year}-${month}`;
            const dayNum = parseInt(day);

            const storageKey = `att_${cls}_${monthStr}`;
            let data = JSON.parse(localStorage.getItem(storageKey)) || {};
            let studentData = data[roll] || {};

            // Cycle: Null -> P -> A -> Null
            const current = studentData[dayNum];
            let nextStatus = null;

            if (!current) nextStatus = 'P';
            else if (current === 'P') nextStatus = 'A';
            else if (current === 'A') nextStatus = null; // Back to unmarked

            if (nextStatus) studentData[dayNum] = nextStatus;
            else delete studentData[dayNum];

            data[roll] = studentData;
            localStorage.setItem(storageKey, JSON.stringify(data));

            // Reload UI to show changes
            loadDailyView();
        }

        // 3. SHOW HISTORY MODAL (Read-Only View)
        function openHistoryModal(roll, name) {
            const fullDate = document.getElementById("attDate").value;
            const [year, month] = fullDate.split('-');
            const monthStr = `${year}-${month}`;
            const daysInMonth = new Date(year, month, 0).getDate();

            document.getElementById("histName").innerText = name;
            
            const cls = document.getElementById("attClass").value;
            const attData = JSON.parse(localStorage.getItem(`att_${cls}_${monthStr}`)) || {};
            const holidays = JSON.parse(localStorage.getItem(`holidays_${monthStr}`)) || [];
            const studentRecord = attData[roll] || {};

            const grid = document.getElementById("histGrid");
            grid.innerHTML = "";

            for(let i=1; i<=daysInMonth; i++) {
                const dayDiv = document.createElement("div");
                dayDiv.className = "cal-day";
                dayDiv.innerText = i;

                if(holidays.includes(i)) dayDiv.classList.add("is-holiday");
                else if(studentRecord[i] === 'P') dayDiv.classList.add("is-present");
                else if(studentRecord[i] === 'A') dayDiv.classList.add("is-absent");

                grid.appendChild(dayDiv);
            }

            document.getElementById("historyModal").style.display = "flex";
        }

        // 4. HOLIDAY MANAGER
        function openGlobalHolidayModal() {
            const fullDate = document.getElementById("attDate").value;
            const [year, month] = fullDate.split('-');
            const monthStr = `${year}-${month}`;
            const daysInMonth = new Date(year, month, 0).getDate();
            
            const grid = document.getElementById("holidayGrid");
            grid.innerHTML = "";

            const holidayKey = `holidays_${monthStr}`;
            let holidays = JSON.parse(localStorage.getItem(holidayKey)) || [];

            for(let i=1; i<=daysInMonth; i++) {
                const dayDiv = document.createElement("div");
                dayDiv.className = "cal-day";
                dayDiv.innerText = i;
                if(holidays.includes(i)) dayDiv.classList.add("is-holiday");

                dayDiv.onclick = function() {
                    if(holidays.includes(i)) {
                        holidays = holidays.filter(d => d !== i);
                        dayDiv.classList.remove("is-holiday");
                    } else {
                        holidays.push(i);
                        dayDiv.classList.add("is-holiday");
                    }
                    localStorage.setItem(holidayKey, JSON.stringify(holidays));
                };
                grid.appendChild(dayDiv);
            }
            document.getElementById("holidayModal").style.display = "flex";
        }

    </script>
    
    <script src="script.js?v=attendance_daily_final1"></script>

</body>
</html>
