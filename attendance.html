<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Attendance - Student Register</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#9b59b6">

    <style>
        /* Base Layout */
        body { padding-bottom: 70px; transition: background 0.3s; }
        .attendance-header { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; }
        
        /* Controls */
        .date-picker { flex: 2; padding: 12px; font-size: 16px; border: 1px solid var(--border); border-radius: 8px; background: var(--card); color: var(--text); }
        select { flex: 1; padding: 12px; font-size: 16px; border: 1px solid var(--border); border-radius: 8px; background: var(--card); color: var(--text); }
        .btn-holiday-manage { flex: 1; padding: 12px; background: var(--card); border: 1px solid var(--border); color: var(--text); border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* Dashboard Stats */
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-card { padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .stat-label { font-size: 12px; opacity: 0.9; display: block; margin-bottom: 5px; text-transform: uppercase; }
        .stat-value { font-size: 24px; font-weight: bold; }

        /* Student Card */
        .attendance-card {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--card); padding: 15px; margin-bottom: 10px;
            border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
        }
        .student-info h4 { margin: 0; font-size: 16px; color: var(--text); }
        .student-info p { margin: 5px 0 0; font-size: 13px; color: var(--placeholder); }

        /* Action Buttons */
        .action-group { display: flex; gap: 10px; align-items: center; }
        
        .toggle-btn {
            padding: 8px 0; width: 80px; border-radius: 8px; cursor: pointer;
            font-weight: bold; border: none; transition: 0.2s; text-align: center; font-size: 12px;
        }

        /* üé® STATUS COLORS */
        .status-p { background: #d1fae5; color: #065f46; border: 1px solid #34d399; }
        .status-a { background: #fee2e2; color: #991b1b; border: 1px solid #f87171; }
        .status-u { background: var(--bg); color: var(--placeholder); border: 1px solid var(--border); } /* Unmarked */
        .status-h { background: #fef3c7; color: #d97706; border: 1px solid #f59e0b; pointer-events: none; } /* Holiday */

        /* Dark Mode Overrides */
        [data-theme="dark"] .status-p { background: #064e3b; color: #a7f3d0; border-color: #059669; }
        [data-theme="dark"] .status-a { background: #7f1d1d; color: #fecaca; border-color: #b91c1c; }
        [data-theme="dark"] .status-u { background: #374151; color: #9ca3af; border-color: #4b5563; }
        [data-theme="dark"] .status-h { background: #78350f; color: #fcd34d; border-color: #b45309; }

        .history-btn { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 8px; cursor: pointer; font-size: 16px; }

        /* üíæ SAVE BAR */
        #saveBar {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(150px);
            width: 90%; max-width: 380px; background: #222; padding: 12px 20px; border-radius: 50px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 10000; border: 1px solid #444;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #saveBar.show { transform: translateX(-50%) translateY(0); }
        #saveBar span { color: #f1c40f; font-weight: bold; font-size: 13px; }
        .save-actions { display: flex; gap: 10px; }
        .btn-discard { background: #444; color: white; border: none; padding: 8px 12px; border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 12px; }
        .btn-save-confirm { background: #27ae60; color: white; border: none; padding: 8px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 12px; }

        /* MODALS */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(5px); }
        .modal-content { background: var(--card); padding: 25px; border-radius: 20px; width: 85%; max-width: 350px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); max-height: 85vh; overflow-y: auto; }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin: 20px 0; }
        .day-box { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 5px; font-size: 12px; font-weight: bold; background: var(--bg); color: var(--placeholder); border: 1px solid var(--border); cursor: pointer; }
        
        .day-present { background: #27ae60 !important; color: white !important; border:none; }
        .day-absent { background: #e74c3c !important; color: white !important; border:none; }
        .day-holiday { background: #f39c12 !important; color: white !important; border:none; }

        .close-btn { background: var(--text); color: var(--bg); border: none; padding: 10px 20px; border-radius: 50px; font-weight: bold; width: 100%; margin-top: 10px; }
        .theme-toggle { background: var(--card); border: 1px solid var(--border); color: var(--text); padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 16px; }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed !important; bottom: 15px !important; left: 50% !important; transform: translateX(-50%) !important;
            width: 75% !important; max-width: 350px !important; height: 48px !important;
            background-color: #ffffff !important; display: flex !important; justify-content: space-evenly !important; align-items: center !important;
            border-radius: 30px !important; border: 1px solid #c0c0c0 !important; box-shadow: 0 12px 35px rgba(0,0,0,0.25) !important; z-index: 9999 !important;
        }
        [data-theme="dark"] .bottom-nav { background-color: #2c2c2c !important; border: 1px solid #444 !important; box-shadow: 0 10px 30px rgba(0,0,0,0.8) !important; }
        .nav-item { background: transparent !important; border: none !important; color: #999 !important; display: flex !important; flex-direction: column !important; align-items: center !important; justify-content: center !important; font-size: 9px !important; padding: 0 5px !important; cursor: pointer !important; position: relative !important; }
        .nav-icon { font-size: 20px !important; margin-bottom: 2px !important; display: block !important; }
        .nav-item.active { color: #9b59b6 !important; font-weight: bold !important; }
        .nav-item.active::after { content: '' !important; position: absolute !important; bottom: 5px !important; width: 36px !important; height: 3px !important; background-color: #9b59b6 !important; border-radius: 10px !important; }
        [data-theme="dark"] .nav-item.active { color: #e0b0ff !important; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <div style="display:flex; align-items:center; gap:10px;">
                <h3 style="margin:0; color:var(--text);">Attendance</h3>
            </div>
            <button class="theme-toggle" id="themeBtn" onclick="toggleLocalTheme()">üåô</button>
        </div>

        <div class="attendance-header">
            <input type="date" id="attDate" class="date-picker" onchange="loadAttendance()">
            <button class="btn-holiday-manage" onclick="openHolidayModal()">üèñÔ∏è Holidays</button>
        </div>
        <div class="attendance-header">
            <select id="attClass" onchange="loadAttendance()">
                <option value="6">Class 6</option>
                <option value="7">Class 7</option>
                <option value="8">Class 8</option>
                <option value="9">Class 9</option>
                <option value="10">Class 10</option>
            </select>
        </div>

        <div class="dashboard">
            <div class="stat-card" style="background:#27ae60; color:white;">
                <span class="stat-label">Present</span>
                <span class="stat-value" id="countPresent">0</span>
            </div>
            <div class="stat-card" style="background:#e74c3c; color:white;">
                <span class="stat-label">Absent</span>
                <span class="stat-value" id="countAbsent">0</span>
            </div>
        </div>

        <div id="monthLabel" style="text-align:center; font-size:13px; color:var(--placeholder); margin-bottom:15px; font-weight:bold;">Loading...</div>

        <div id="attendanceList"></div>
        <div style="height: 60px;"></div> </div>

    <div id="saveBar">
        <span>‚ö†Ô∏è Unsaved Changes</span>
        <div class="save-actions">
            <button class="btn-discard" onclick="discardChanges()">Cancel</button>
            <button class="btn-save-confirm" onclick="saveAttendance()">Save</button>
        </div>
    </div>

    <div id="historyModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">Student History</h3>
            <p id="modalSubtitle" style="color:var(--placeholder); font-size:13px;"></p>
            <div class="calendar-grid" id="modalGrid"></div>
            <button class="close-btn" onclick="document.getElementById('historyModal').style.display='none'">Close</button>
        </div>
    </div>

    <div id="holidayModal" class="modal">
        <div class="modal-content">
            <h3>Manage Holidays</h3>
            <p style="color:var(--placeholder); font-size:13px;">Tap days to mark/unmark holidays</p>
            <div class="calendar-grid" id="holidayGrid"></div>
            <button class="close-btn" onclick="closeHolidayModal()">Done</button>
        </div>
    </div>

    <div class="bottom-nav">
        <button onclick="window.location.href='index.html'" class="nav-item">
            <span class="nav-icon">üë®‚Äçüéì</span>
        </button>
        <button onclick="window.location.href='attendance.html'" class="nav-item active">
            <span class="nav-icon">üìÖ</span>
        </button>
        <button onclick="window.location.href='results.html'" class="nav-item">
            <span class="nav-icon">üìä</span>
        </button>
    </div>

    <script>
        // GLOBAL STATE
        let tempData = {}; 
        let hasUnsavedChanges = false;
        let lastValidDate = null; 

        // 1. Initialize
        window.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem("theme") || "light";
            document.body.setAttribute("data-theme", savedTheme);
            document.getElementById("themeBtn").innerText = savedTheme === "dark" ? "‚òÄÔ∏è" : "üåô";

            const today = new Date();
            document.getElementById('attDate').valueAsDate = today;
            lastValidDate = document.getElementById('attDate').value;

            loadAttendance();
        });

        function toggleLocalTheme() {
            const current = document.body.getAttribute("data-theme");
            const newTheme = current === "dark" ? "light" : "dark";
            document.body.setAttribute("data-theme", newTheme);
            localStorage.setItem("theme", newTheme);
            document.getElementById("themeBtn").innerText = newTheme === "dark" ? "‚òÄÔ∏è" : "üåô";
        }

        // 2. Load Data (Draft Mode)
        function loadAttendance() {
            // Unsaved Changes Check
            if(hasUnsavedChanges) {
                if(!confirm("Discard unsaved changes?")) {
                    document.getElementById('attDate').value = lastValidDate; // Revert date
                    return;
                }
            }

            hasUnsavedChanges = false;
            document.getElementById("saveBar").classList.remove("show");
            lastValidDate = document.getElementById('attDate').value;

            const listContainer = document.getElementById("attendanceList");
            const selectedDate = document.getElementById("attDate").value;
            const selectedClass = document.getElementById("attClass").value;
            
            if(!selectedDate) return;

            const [year, month, day] = selectedDate.split("-");
            const monthStr = `${year}-${month}`;
            const dayNum = parseInt(day);

            // Update Month Label
            const dateObj = new Date(year, month - 1, day);
            const monthName = dateObj.toLocaleString('default', { month: 'long', year: 'numeric' });
            document.getElementById("monthLabel").innerText = `Viewing Data for: ${monthName}`;

            // Fetch Data
            const students = JSON.parse(localStorage.getItem("students")) || [];
            // Clone data for editing
            const storedData = JSON.parse(localStorage.getItem(`attendance_${selectedClass}_${monthStr}`)) || {};
            tempData = storedData; 

            const holidays = JSON.parse(localStorage.getItem(`holidays_${monthStr}`)) || [];
            const isHoliday = holidays.includes(dayNum);

            const classStudents = students.filter(s => s.studentClass === selectedClass);
            classStudents.sort((a, b) => parseInt(a.roll) - parseInt(b.roll));

            let html = "";
            let pCount = 0, aCount = 0;

            if (classStudents.length === 0) {
                listContainer.innerHTML = `<div style="text-align:center; padding:30px; color:var(--placeholder);">No students in Class ${selectedClass}.</div>`;
                updateStats(0, 0);
                return;
            }

            classStudents.forEach(s => {
                const studentRecord = tempData[s.roll] || {};
                const status = studentRecord[dayNum]; 

                // Determine Button Style
                let btnClass = "status-u";
                let btnText = "MARK";

                if (isHoliday) {
                    btnClass = "status-h"; btnText = "HOLIDAY";
                } else if (status === true) {
                    btnClass = "status-p"; btnText = "PRESENT"; pCount++;
                } else if (status === false) {
                    btnClass = "status-a"; btnText = "ABSENT"; aCount++;
                }

                html += `
                <div class="attendance-card">
                    <div class="student-info">
                        <h4>${s.name}</h4>
                        <p>Roll: ${s.roll}</p>
                    </div>
                    <div class="action-group">
                        <button class="history-btn" onclick="openHistory('${s.roll}', '${s.name}', '${s.studentClass}')">üìú</button>
                        <button class="toggle-btn ${btnClass}" onclick="toggleStatus('${s.roll}', ${isHoliday}, this)">${btnText}</button>
                    </div>
                </div>`;
            });

            listContainer.innerHTML = html;
            updateStats(pCount, aCount);
        }

        // 3. Toggle Status (Cycle)
        function toggleStatus(roll, isHoliday, btn) {
            if (isHoliday) {
                alert("Cannot mark attendance on a Holiday!");
                return;
            }

            hasUnsavedChanges = true;
            document.getElementById("saveBar").classList.add("show");

            const fullDate = document.getElementById("attDate").value;
            const dayNum = parseInt(fullDate.split("-")[2]);

            // Initialize record if needed
            if(!tempData[roll]) tempData[roll] = {};
            
            const current = tempData[roll][dayNum];
            let nextVal = null; // Default Unmarked

            // Cycle: Null -> True (P) -> False (A) -> Null
            if (current === undefined || current === null) nextVal = true;
            else if (current === true) nextVal = false;
            else if (current === false) nextVal = null;

            // Update Temp Data
            if (nextVal !== null) tempData[roll][dayNum] = nextVal;
            else delete tempData[roll][dayNum];

            // Update UI Button Immediately
            if (nextVal === true) { btn.className = "toggle-btn status-p"; btn.innerText = "PRESENT"; }
            else if (nextVal === false) { btn.className = "toggle-btn status-a"; btn.innerText = "ABSENT"; }
            else { btn.className = "toggle-btn status-u"; btn.innerText = "MARK"; }

            // Recalculate Stats locally
            recalcStats(dayNum);
        }

        function recalcStats(dayNum) {
            let p = 0, a = 0;
            Object.values(tempData).forEach(rec => {
                if (rec[dayNum] === true) p++;
                if (rec[dayNum] === false) a++;
            });
            updateStats(p, a);
        }

        function updateStats(p, a) {
            document.getElementById("countPresent").innerText = p;
            document.getElementById("countAbsent").innerText = a;
        }

        // 4. Save & Discard
        function saveAttendance() {
            const selectedClass = document.getElementById("attClass").value;
            const fullDate = document.getElementById("attDate").value;
            const monthStr = fullDate.substring(0, 7);

            localStorage.setItem(`attendance_${selectedClass}_${monthStr}`, JSON.stringify(tempData));
            
            hasUnsavedChanges = false;
            document.getElementById("saveBar").classList.remove("show");

            const btn = document.querySelector(".btn-save-confirm");
            btn.innerText = "Saved!";
            setTimeout(() => btn.innerText = "Save", 2000);
        }

        function discardChanges() {
            if(confirm("Discard changes?")) {
                loadAttendance(); // Reloads from storage, wiping temp changes
            }
        }

        // 5. History Modal
        function openHistory(roll, name, studentClass) {
            const modal = document.getElementById("historyModal");
            const grid = document.getElementById("modalGrid");
            const dateInput = document.getElementById("attDate").value; 
            const [year, month] = dateInput.split("-");
            const monthStr = `${year}-${month}`;
            
            // Use TempData so we see what we just edited
            const studentRecord = tempData[roll] || {};
            const holidays = JSON.parse(localStorage.getItem(`holidays_${monthStr}`)) || [];

            document.getElementById("modalTitle").innerText = name;
            document.getElementById("modalSubtitle").innerText = `History for ${year}-${month}`;

            const daysInMonth = new Date(year, month, 0).getDate();
            let gridHTML = "";

            for(let d = 1; d <= daysInMonth; d++) {
                let dayClass = ""; 
                if (holidays.includes(d)) dayClass = "day-holiday";
                else if (studentRecord[d] === true) dayClass = "day-present";
                else if (studentRecord[d] === false) dayClass = "day-absent";
                
                gridHTML += `<div class="day-box ${dayClass}">${d}</div>`;
            }
            grid.innerHTML = gridHTML;
            modal.style.display = "flex";
        }

        // 6. Holiday Modal
        function openHolidayModal() {
            const dateInput = document.getElementById("attDate").value; 
            const [year, month] = dateInput.split("-");
            const monthStr = `${year}-${month}`;
            const grid = document.getElementById("holidayGrid");

            // Warn if unsaved attendance changes exist
            if(hasUnsavedChanges) {
                alert("Please save or discard attendance changes before managing holidays.");
                return;
            }

            const holidays = JSON.parse(localStorage.getItem(`holidays_${monthStr}`)) || [];
            const daysInMonth = new Date(year, month, 0).getDate();
            let gridHTML = "";

            grid.innerHTML = "";
            for(let d = 1; d <= daysInMonth; d++) {
                const div = document.createElement("div");
                div.className = "day-box";
                div.innerText = d;
                if(holidays.includes(d)) div.classList.add("day-holiday");

                div.onclick = function() {
                    let currentHolidays = JSON.parse(localStorage.getItem(`holidays_${monthStr}`)) || [];
                    if(currentHolidays.includes(d)) {
                        currentHolidays = currentHolidays.filter(x => x !== d);
                        div.classList.remove("day-holiday");
                    } else {
                        currentHolidays.push(d);
                        div.classList.add("day-holiday");
                    }
                    localStorage.setItem(`holidays_${monthStr}`, JSON.stringify(currentHolidays));
                };
                grid.appendChild(div);
            }

            document.getElementById("holidayModal").style.display = "flex";
        }

        function closeHolidayModal() {
            document.getElementById("holidayModal").style.display = "none";
            loadAttendance(); // Refresh list to show new holidays
        }
    </script>
</body>
</html>
