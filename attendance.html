<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Attendance - Student Register</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#9b59b6">

    <style>
        /* Base Styles */
        body { padding-bottom: 70px !important; }
        .controls-row { display: flex; gap: 10px; margin-bottom: 10px; }
        
        select, input[type="month"] { 
            flex: 1; padding: 12px; border-radius: 8px; 
            border: 1px solid var(--border); background: var(--card); 
            color: var(--text); width: 100%; font-size: 14px;
        }

        /* Student List Styles */
        .student-item {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--card); padding: 15px; margin-bottom: 10px;
            border-radius: 12px; border: 1px solid var(--border);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer;
        }
        .student-item:active { transform: scale(0.98); }

        /* MODAL & CALENDAR STYLES */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 1000;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background: var(--card); padding: 20px; border-radius: 20px; 
            width: 90%; max-width: 400px; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            max-height: 90vh; overflow-y: auto;
        }

        /* Summary Boxes */
        .summary-row { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; }
        .summary-box {
            flex: 1; padding: 10px; border-radius: 10px;
            background: #2c2c2c; 
            border: 1px solid #444;
            display: flex; flex-direction: column; align-items: center;
        }
        .sum-label { font-size: 11px; color: #aaa; margin-bottom: 4px; text-transform: uppercase; }
        .sum-val { font-size: 20px; font-weight: bold; }

        /* Text Colors */
        .text-p { color: #2ecc71; } 
        .text-a { color: #e74c3c; } 
        .text-h { color: #f39c12; } 

        /* Calendar Grid */
        .calendar-grid {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 20px;
        }
        .cal-day {
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
            background: var(--bg); border-radius: 8px; border: 1px solid var(--border);
            font-weight: bold; font-size: 14px; cursor: pointer; transition: 0.1s;
            user-select: none; color: var(--text);
        }
        
        /* üé® STATUS COLORS */
        .is-present { background-color: #27ae60 !important; color: white !important; border-color: #27ae60 !important; }
        .is-absent  { background-color: #c0392b !important; color: white !important; border-color: #c0392b !important; }
        .is-holiday { background-color: #f39c12 !important; color: white !important; border-color: #d35400 !important; }

        .btn-close { width: 100%; padding: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-weight: bold; }
        .btn-holiday { width: 100%; padding: 12px; background: #f39c12; border: none; border-radius: 8px; color: white; font-weight: bold; margin-bottom: 10px; }

        /* Theme Toggle */
        .theme-toggle {
            background: var(--card); border: 1px solid var(--border); color: var(--text);
            padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 16px;
        }
        
        /* Floating Bar Styles */
        .bottom-nav {
            position: fixed !important; bottom: 15px !important; left: 50% !important;
            transform: translateX(-50%) !important; width: 75% !important;
            max-width: 350px !important; height: 48px !important;
            background-color: #ffffff !important; display: flex !important;
            justify-content: space-evenly !important; align-items: center !important;
            border-radius: 30px !important; border: 1px solid #c0c0c0 !important;
            box-shadow: 0 12px 35px rgba(0,0,0,0.25) !important; z-index: 9999 !important;
        }
        [data-theme="dark"] .bottom-nav {
            background-color: #2c2c2c !important; border: 1px solid #444 !important;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8) !important;
        }
        .nav-item {
            background: transparent !important; border: none !important;
            color: #999 !important; display: flex !important; flex-direction: column !important;
            align-items: center !important; justify-content: center !important;
            font-size: 9px !important; padding: 0 5px !important; cursor: pointer !important;
        }
        .nav-icon { font-size: 20px !important; margin-bottom: 2px !important; display: block !important; }
        .nav-item.active { color: #9b59b6 !important; font-weight: bold !important; }
        .nav-item.active .nav-icon { transform: translateY(-2px) !important; }
        [data-theme="dark"] .nav-item.active { color: #e0b0ff !important; }

    </style>
</head>
<body>

    <div class="container">
        <div class="header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0; color:var(--text);">Attendance</h3>
            <button class="theme-toggle" id="themeBtn" onclick="toggleLocalTheme()">üåô</button>
        </div>

        <div class="controls-row">
            <input type="month" id="attMonth" onchange="loadStudents()" style="flex:2;">
            <button onclick="openGlobalHolidayModal()" style="flex:1; background:var(--card); border:1px solid var(--border); border-radius:8px; cursor:pointer;">üèñÔ∏è Holidays</button>
        </div>
        <div class="controls-row">
             <select id="attClass" onchange="loadStudents()">
                <option value="6">Class 6</option>
                <option value="7">Class 7</option>
                <option value="8">Class 8</option>
                <option value="9">Class 9</option>
                <option value="10">Class 10</option>
            </select>
        </div>

        <hr style="border:0; border-top:1px solid var(--border); margin:15px 0;">

        <div id="attList"></div>
    </div>

    <div id="attModal" class="modal">
        <div class="modal-content">
            <h3 id="modalName" style="margin:0 0 5px 0; color:var(--text);">Student Name</h3>
            <p id="modalSubtitle" style="font-size:12px; color:var(--placeholder); margin-bottom:20px;"></p>

            <div class="summary-row">
                <div class="summary-box">
                    <span class="sum-label">Present</span>
                    <span class="sum-val text-p" id="countP">0</span>
                </div>
                <div class="summary-box">
                    <span class="sum-label">Absent</span>
                    <span class="sum-val text-a" id="countA">0</span>
                </div>
                <div class="summary-box">
                    <span class="sum-label">Holiday</span>
                    <span class="sum-val text-h" id="countH">0</span>
                </div>
            </div>

            <div class="calendar-grid" id="calGrid"></div>

            <p style="font-size:11px; color:var(--placeholder); margin-top:-10px; margin-bottom:15px;">
                Tap to toggle: Present üü¢ / Absent üî¥
            </p>

            <button class="btn-close" onclick="closeAttModal()">Close</button>
        </div>
    </div>

    <div id="holidayModal" class="modal">
        <div class="modal-content">
            <h3 style="margin:0 0 5px 0; color:var(--text);">Manage Holidays</h3>
            <p style="font-size:12px; color:var(--placeholder); margin-bottom:20px;">Tap days to mark as School Holiday üèñÔ∏è</p>
            
            <div class="calendar-grid" id="holidayGrid"></div>
            
            <button class="btn-close" onclick="document.getElementById('holidayModal').style.display='none'; loadStudents();">Done</button>
        </div>
    </div>

    <div class="bottom-nav">
        <button onclick="window.location.href='index.html'" class="nav-item">
            <span class="nav-icon">üë®‚Äçüéì</span>
        </button>
        <button onclick="window.location.href='attendance.html'" class="nav-item active">
            <span class="nav-icon">üìÖ</span>
        </button>
        <button onclick="window.location.href='results.html'" class="nav-item">
            <span class="nav-icon">üìä</span>
        </button>
    </div>

    <script>
        let currentStudentRoll = null;

        window.onload = function() {
            const savedTheme = localStorage.getItem("theme") || "light";
            document.body.setAttribute("data-theme", savedTheme);
            document.getElementById("themeBtn").innerText = savedTheme === "dark" ? "‚òÄÔ∏è" : "üåô";

            const date = new Date();
            const monthStr = date.toISOString().slice(0, 7); 
            document.getElementById("attMonth").value = monthStr;

            loadStudents();
        };

        function toggleLocalTheme() {
            const current = document.body.getAttribute("data-theme");
            const newTheme = current === "dark" ? "light" : "dark";
            document.body.setAttribute("data-theme", newTheme);
            localStorage.setItem("theme", newTheme);
            document.getElementById("themeBtn").innerText = newTheme === "dark" ? "‚òÄÔ∏è" : "üåô";
        }

        // 1. Load Student List
        function loadStudents() {
            const cls = document.getElementById("attClass").value;
            const students = JSON.parse(localStorage.getItem("students")) || [];
            
            const filtered = students.filter(s => s.studentClass === cls);
            filtered.sort((a, b) => parseInt(a.roll) - parseInt(b.roll));

            const list = document.getElementById("attList");
            list.innerHTML = "";

            if(filtered.length === 0) {
                list.innerHTML = "<div style='text-align:center; padding:20px; color:var(--placeholder)'>No students found.</div>";
                return;
            }

            filtered.forEach(s => {
                list.innerHTML += `
                <div class="student-item" onclick="openAttModal('${s.roll}', '${s.name}')">
                    <div>
                        <div style="font-weight:bold; color:var(--text);">${s.name}</div>
                        <div style="font-size:12px; color:var(--placeholder);">Roll: ${s.roll}</div>
                    </div>
                    <div style="font-size:20px;">üìÖ</div>
                </div>`;
            });
        }

        // 2. GLOBAL HOLIDAY MANAGER
        function openGlobalHolidayModal() {
            const monthStr = document.getElementById("attMonth").value;
            const [year, month] = monthStr.split('-').map(Number);
            const daysInMonth = new Date(year, month, 0).getDate();
            const grid = document.getElementById("holidayGrid");
            grid.innerHTML = "";

            // Get Global Holidays
            const holidayKey = `holidays_${monthStr}`;
            let holidays = JSON.parse(localStorage.getItem(holidayKey)) || [];

            for(let i = 1; i <= daysInMonth; i++) {
                const dayDiv = document.createElement("div");
                dayDiv.className = "cal-day";
                dayDiv.innerText = i;

                if(holidays.includes(i)) dayDiv.classList.add("is-holiday");

                dayDiv.onclick = function() {
                    if(holidays.includes(i)) {
                        holidays = holidays.filter(d => d !== i); // Remove
                        dayDiv.classList.remove("is-holiday");
                    } else {
                        holidays.push(i); // Add
                        dayDiv.classList.add("is-holiday");
                    }
                    localStorage.setItem(holidayKey, JSON.stringify(holidays));
                };
                grid.appendChild(dayDiv);
            }
            document.getElementById("holidayModal").style.display = "flex";
        }

        // 3. STUDENT ATTENDANCE MODAL
        function openAttModal(roll, name) {
            currentStudentRoll = roll;
            document.getElementById("modalName").innerText = name;
            const monthVal = document.getElementById("attMonth").value; 
            document.getElementById("modalSubtitle").innerText = `Attendance for ${monthVal}`;
            
            generateCalendar(monthVal);
            document.getElementById("attModal").style.display = "flex";
        }

        function closeAttModal() {
            document.getElementById("attModal").style.display = "none";
        }

        function generateCalendar(monthStr) {
            const [year, month] = monthStr.split('-').map(Number);
            const daysInMonth = new Date(year, month, 0).getDate();
            const grid = document.getElementById("calGrid");
            grid.innerHTML = "";

            // Get Data
            const cls = document.getElementById("attClass").value;
            const storageKey = `att_${cls}_${monthStr}`; 
            let data = JSON.parse(localStorage.getItem(storageKey)) || {};
            let studentData = data[currentStudentRoll] || {};

            // Get Holidays
            const holidayKey = `holidays_${monthStr}`;
            let holidays = JSON.parse(localStorage.getItem(holidayKey)) || [];

            let p = 0, a = 0, h = 0;

            for(let i = 1; i <= daysInMonth; i++) {
                const dayDiv = document.createElement("div");
                dayDiv.className = "cal-day";
                dayDiv.innerText = i;
                
                const isGlobalHoliday = holidays.includes(i);
                const status = studentData[i]; 

                if (isGlobalHoliday) {
                    dayDiv.classList.add("is-holiday"); // Forced Holiday
                    h++;
                } else if(status === 'P') {
                    dayDiv.classList.add("is-present");
                    p++;
                } else if(status === 'A') {
                    dayDiv.classList.add("is-absent");
                    a++;
                }

                // Toggle Logic (Only if NOT a holiday)
                dayDiv.onclick = function() {
                    if(isGlobalHoliday) return; // Can't change global holiday here

                    let newStatus = null;
                    if(!status) newStatus = 'P';
                    else if(status === 'P') newStatus = 'A';
                    else if(status === 'A') newStatus = null; // Clear

                    if(newStatus) studentData[i] = newStatus;
                    else delete studentData[i];

                    data[currentStudentRoll] = studentData;
                    localStorage.setItem(storageKey, JSON.stringify(data));
                    generateCalendar(monthStr); // Refresh
                };

                grid.appendChild(dayDiv);
            }

            document.getElementById("countP").innerText = p;
            document.getElementById("countA").innerText = a;
            document.getElementById("countH").innerText = h;
        }
    </script>
    
    <script src="script.js?v=attendance_final"></script>

</body>
</html>
